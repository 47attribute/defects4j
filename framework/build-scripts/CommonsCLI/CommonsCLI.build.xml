<project name="CommonsCLI" basedir="${basedir}">

    <!-- Force build in Java 1.7 for older versions of the project -->
    <property name="build.compiler" value="javac1.7"/>

    <property name="compile.debug" value="yes" />

    <fail message="Property script.dir not set!" unless="script.dir" />

    <property name="junit" value="${script.dir}/build-scripts/lib/junit-4.11.jar"/>

    <import file="../project.build.xml"/>

    <property name="build.home" value="${basedir}" />
    <property name="test.src.home" value="${basedir}/src/test"/>
    <property name="source.home" value="${basedir}/src/main"/>
    <property name="test.home" value="${basedir}/target/test-classes"/>
    <property name="classes.dir" value="${basedir}/target/classes"/>
	
    <path id="compile.classpath">
        <pathelement path="${classes.dir}"/>
    </path>

    <path id="test.classpath">
        <pathelement path="${junit}" />
        <pathelement path="${classes.dir}"/>
        <pathelement path="${test.home}"/>
        <pathelement path="${source.home}"/>		
        <pathelement path="${formatter_cp}"/>
        <pathelement path="${test.src.home}"/>
        <fileset dir="${script.dir}/build-scripts/CommonsCLI/lib">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <path id="major.classpath">
        <path refid="test.classpath" />
    </path>
	

    <available file="${basedir}/pom.xml" property="use-mvn"/>

    <target name="compile" description="Compile the  source code.">
        <if>
            <isset property="use-mvn"/>
            <then>
                <exec dir="${basedir}" executable="/bin/bash">			
                    <arg value="mvn"/>
	            <arg value="compile"/>
               </exec>
            </then>
            <else>
                <exec executable="perl" dir="${basedir}">			
                    <arg value="${script.dir}/build-scripts/CommonsCLI/replace_txt.pl"/>
                    <arg value=" ${basedir}"/>			
                </exec>
               <ant antfile="${basedir}/build.xml" target="compile" inheritAll="true"/>
            </else>
        </if>
    </target>

    <target name="compile.tests" description="Compile the tests.">
        <if>
            <isset property="use-mvn"/>
            <then>
                <exec dir="${basedir}" executable="/bin/bash">			
                    <arg value="mvn"/>
                    <arg value="test-compile"/>
                </exec>
            </then>
            <else>
                <exec executable="perl" dir="${basedir}">			
                    <arg value="${script.dir}/build-scripts/CommonsCLI/replace_txt.pl"/>
                    <arg value=" ${basedir}"/>			
                </exec>
                <ant antfile="${basedir}/build.xml" target="compile-tests" inheritAll="true"/>
           </else>
       </if>
    </target>


<!--
    Run tests
-->
    <target name="test"  depends="compile.tests" description="Run unit tests">
        <junit printsummary="no" haltonfailure="no" haltonerror="no" fork="no" showOutput="true">
            <classpath refid="test.classpath"/>

            <sysproperty key="OUTFILE" value="${OUTFILE}"/>
            <formatter classname="edu.washington.cs.mut.testrunner.Formatter" usefile="false" />
            <test name="${test.entry.class}" methods="${test.entry.method}" if="test.entry.class" />
                <batchtest unless="test.entry.class">
                    <fileset dir="${test.home}" excludes="${exclude.list}">
                        <include name="**/*Test.class"/>
                        <exclude name="**/PatternOptionBuilderTest.class"/>
                        <exclude name="**/OptionGroupTest.class"/>
                        <exclude name="**/bug/**/*.class"/>
                        <exclude name="**/BugsTest.class"/>
                    </fileset>
                </batchtest>
        </junit>
    </target>

<!--
    Run individual test and monitor class loader
    Test has to be provided as property "test.entry" (class::method)
    and the output is redirected to "test.output"
-->
    <target name="monitor.test"  description="Run unit test and monitor class loader">
        <java fork="true" classname="edu.washington.cs.mut.testrunner.SingleTestRunner" output="${test.output}"
            failonerror="true">

            <arg value="${test.entry}"/>
            <jvmarg value="-verbose:class"/>
            <classpath refid="test.classpath"/>
            <classpath>
                <pathelement path="${formatter_cp}" />
                <pathelement path="${junit.jar}" />
            </classpath>
        </java>
    </target>
</project>
