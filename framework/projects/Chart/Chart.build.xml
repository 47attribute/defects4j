<project name="Chart"  basedir="${basedir}">

    <!-- script.dir property has to be provided from caller! -->
    <fail message="Property script.dir not set!" unless="script.dir" />

    <property name="junit.jar" value="${script.dir}/projects/lib/junit-4.11.jar"/>

    <!-- Include existing project build file -->
    <import file="${basedir}/ant/build.xml" />

    <!-- Import general build file -->
    <import file="../defects4j.build.xml" />

    <!-- Classpath to run mutation analysis -->
    <path id="major.classpath">
        <pathelement location="${basedir}/build"/>
        <pathelement location="${basedir}/build-tests"/>
    </path>


    <!-- Values necessary for mutation scripting to work -->
    <property name="test.home" value="${basedir}/build-tests" />
    <property name="build.home" value="${basedir}" />
    <property name="classes.dir" value="${basedir}/build" />
    <path id="compile.classpath" refid="build.classpath" />
    <path id="test.classpath">
        <path refid="build.classpath"/>
        <pathelement location="${junit.jar}"/>
        <pathelement location="${classes.dir}" />
        <pathelement location="${basedir}/build-tests"/>
    </path>

    <!-- target used for compiling sources. This was replicated to avoid deleting the compilation directory -->
    <target name="compile" depends="initialise"
            description="Compile the JFreeChart source code.">

        <!-- create a temp build directory -->
        <mkdir dir="${basedir}/build" />

        <javac srcdir="${basedir}/source"
               destdir="${basedir}/build"
               debug="on"
               deprecation="false"
               source="1.4"
               target="1.4">
            <classpath refid="build.classpath" />
            <include name="org/jfree/**"/>
        </javac>

        <!-- copy across gorilla.jpg -->
        <copy file="${basedir}/source/org/jfree/chart/gorilla.jpg" tofile="${basedir}/build/org/jfree/chart/gorilla.jpg" />

        <!-- copy across .properties files -->
        <copy todir="${basedir}/build/org/jfree/chart/">
            <fileset dir="${basedir}/source/org/jfree/chart">
                <include name="*.properties" />
            </fileset>
        </copy>
        <copy todir="${basedir}/build/org/jfree/chart/plot">
            <fileset dir="${basedir}/source/org/jfree/chart/plot">
                <include name="*.properties" />
            </fileset>
        </copy>
        <copy todir="${basedir}/build/org/jfree/chart/editor">
            <fileset dir="${basedir}/source/org/jfree/chart/editor">
                <include name="*.properties" />
            </fileset>
        </copy>
        <copy todir="${basedir}/build/org/jfree/chart/ui">
            <fileset dir="${basedir}/source/org/jfree/chart/ui">
                <include name="*.properties" />
            </fileset>
        </copy>
    </target>


    <!-- Compile the experimental classes.  This was replicated to avoid deleting the compilation directory -->
    <target name="compile-experimental" depends="compile"
            description="Compile the JFreeChart experimental classes">

        <!-- create a temp build directory -->
        <mkdir dir="${basedir}/build" />

        <path id="build.experimental.classpath">
            <pathelement location="${servlet.jar}"/>
        </path>

        <!-- compile the source -->
        <javac srcdir="${basedir}/experimental"
               destdir="${basedir}/build"
               debug="on"
               deprecation="false"
               source="1.4"
               target="1.4">
            <classpath refid="build.experimental.classpath" />
            <include name="org/jfree/experimental/**"/>
            <exclude name="org/jfree/experimental/**/junit/*"/>
        </javac>
    </target>


    <!-- dummy target, used to rename -->
    <target name="compile.tests" depends="compile, compile-experimental">
         <mkdir dir="${basedir}/build-tests"/>
        <javac srcdir="${basedir}/tests"
               destdir="${basedir}/build-tests"
               source="1.4"
               target="1.4"
               debug="true"
               deprecation="false"
               optimize="false">
            <classpath>
                <path refid="build.classpath"/>
                <pathelement location="${junit.jar}"/>
                <pathelement location="${classes.dir}" />
                <pathelement location="${basedir}/build-tests"/>
            </classpath>
        </javac>
    </target>

    <!-- List of all tests that reliably pass on the fixed version -->
    <fileset id="all.manual.tests" dir="${basedir}/tests" excludes="${d4j.tests.exclude}">
        <include name="**/*Tests.java"/>
        <exclude name="**/*Package*.java"/>
    </fileset>

    <!-- RUN THE JUNIT TESTS. -->
    <target name="test"
            depends="compile.tests"
            description="Run the test cases">

        <junit printSummary="yes"
               haltonerror="no" haltonfailure="no" fork="no"
               dir="${basedir}">

            <sysproperty key="basedir" value="${basedir}"/>
            <classpath>
                <pathelement path="${formatter_cp}" />
            </classpath>

            <sysproperty key="OUTFILE" value="${OUTFILE}"/>

            <formatter classname="edu.washington.cs.mut.testrunner.Formatter" usefile="false" />
            <test name="${test.entry.class}" methods="${test.entry.method}" if="test.entry.class"/>

            <classpath>
                <path refid="build.classpath"/>
				<path refid="cobertura.classpath.include" />
                <pathelement location="${junit.jar}"/>
                <pathelement location="${classes.dir}" />
                <pathelement location="${basedir}/build-tests"/>
            </classpath>

            <batchtest unless="test.entry.class">
                <fileset refid="all.manual.tests" />
            </batchtest>
        </junit>
        <!-- fail build in case we are running all classes, but there are none in the fileset -->
        <if> <not> <isset property="test.entry.class" /> </not> <then>
            <pathconvert refid="all.manual.tests" property="fileset.notempty" setonempty="false" />
            <fail unless="fileset.notempty" message="Test is running with empty fileset" />
        </then> </if>
    </target>
</project>
